### 多模型协作任务处理系统开发需求

#### 一、项目目标
开发一个支持 “模型自动处理 + 人工干预确认” 的多模型协作系统，通过规划模型、人工反馈环节、执行模型、输出模型的协同，将用户输入的问题 / 需求转化为结构化处理流程，经人工确认后执行，最终生成符合预期的结果。系统需支持任务分解、人工校验修改、按依赖调度执行（串行 / 并行）、外部服务调用及结果整合。


#### 二、核心组件及职责
1. **规划模型（Planner Model）**
   - 输入：用户原始问题/需求描述（文本形式，可能包含领域信息、约束条件、预期输出格式等）。
   - 输出：结构化的任务待办清单，写入文件，以**有向无环图（DAG）** 形式呈现。
   - 核心能力：
     - 问题分析：解析需求的核心目标、领域属性、复杂度及潜在约束（如时间、资源限制）。
     - 任务分解：将原始需求拆解为若干可执行的子任务，确保子任务粒度适中（可独立完成且覆盖完整需求）。
     - DAG构建：定义子任务间的依赖关系（如“任务B需在任务A完成后执行”“任务C与任务D可并行执行”），确保无循环依赖。
   - DAG数据结构规范：
     ```json
     {
       "task_graph": {
         "nodes": [
           {
             "task_id": "唯一标识符（如T1）",
             "task_desc": "子任务具体描述（如“查询XX数据”“计算XX指标”）",
             "task_type": "类型（如“本地计算”“mcp调用”“数据处理”）",
             "expected_output": "子任务预期输出格式/内容描述",
             "priority": "优先级（1-5，数字越大优先级越高，用于资源竞争时调度）"
           }
         ],
         "edges": [
           {
             "from_task_id": "前置任务ID",
             "to_task_id": "依赖任务ID",
             "dependency_type": "依赖类型（如“数据依赖”“结果依赖”）"
           }
         ]
       }
     }
     ```
    - 人工操作权限：
        - 确认：若认可原始 DAG，点击 “确认” 按钮，DAG 直接流转至执行模型。
        - 修改：若需调整，支持以下操作（修改后系统自动校验 DAG 无环性，若存在循环依赖则提示错误）：
        - 增删任务节点（需补充 / 删除对应 task_id、desc 等信息）；
        - 调整任务依赖关系（修改 edges 中的 from/to_task_id）；
        - 编辑任务属性（如 task_type、priority、expected_output）。

2. **执行模型（Executor Model）**
   - 输入：人工确认后的规划模型生成的DAG、用户原始问题。
   - 输出：所有子任务的执行结果集（含每个任务的状态、输出内容、执行时长等）。
   - 核心能力：
     - 任务调度：基于DAG的依赖关系，自动规划执行顺序：
       - 串行执行：存在依赖关系的任务按“前置任务完成→后置任务启动”的顺序执行。
       - 并行执行：无依赖关系的任务（即入度为0的节点）可同时启动，利用多线程/进程资源。
     - 任务执行：
       - 对“本地计算”类型任务：直接调用内置逻辑处理（如数据转换、简单计算）。
       - 对“mcp调用”类型任务：通过预设接口调用mcp服务（需定义接口参数格式：`{task_id, input_data, timeout}`），并接收返回结果。
     - 状态管理：实时记录任务状态（待执行/执行中/成功/失败），对失败任务支持重试（可配置重试次数，默认3次）。
   - 结果集数据结构规范：
     ```json
     {
       "execution_results": [
         {
           "task_id": "对应DAG中的任务ID",
           "status": "执行状态（success/failed）",
           "output": "任务执行结果（结构化数据/文本，需与expected_output匹配）",
           "execution_time": "执行时长（秒）",
           "error_msg": "失败时的错误信息（成功时为null）"
         }
       ]
     }
     ```


3. **输出模型（Output Model）**
   - 输入：执行模型的结果集、用户原始问题、规划模型的DAG（可选，用于追溯任务关联）。
   - 输出：针对原始问题的最终答案（支持多格式，如自然语言回答、结构化报告、表格等，需匹配用户潜在需求）。
   - 核心能力：
     - 结果整合：将分散的子任务结果按逻辑关联整合（如“任务A的统计数据+任务B的分析结论→综合报告”）。
     - 一致性校验：检查子任务结果间是否存在冲突（如数据矛盾），若存在则标注并尝试修正（或提示人工介入）。
     - 格式适配：根据原始问题的语境（如正式报告/日常问答）调整输出风格，确保易读性和准确性。


#### 三、整体流程
1. 触发机制：用户输入问题 / 需求后，系统启动流程，首先调用规划模型。
2. 流转逻辑：
   - 规划模型→生成原始 DAG→传递至人工反馈环节。
   - 人工反馈环节→接收原始 DAG→经确认 / 修改后生成最终生效 DAG→传递至执行模型
   - 执行模型→按DAG调度执行所有任务→生成结果集→传递给输出模型。
   - 输出模型→整合结果→生成最终答案→返回给用户。
3. 异常处理：
   - 若规划模型无法生成有效DAG（如问题模糊），返回提示“请补充问题细节”。
   - 若人工修改后的 DAG 经系统校验存在循环依赖，需提示 “依赖关系无效，请重新调整”，直至生成合法 DAG。
   - 若执行模型中存在任务重试后仍失败，输出模型需在最终结果中明确标注失败任务及影响范围。
   - 所有环节需记录日志（含时间、组件、操作、结果），便于追溯。


#### 四、开发要求
1. 各模型需设计为独立模块，通过标准化接口（如函数调用、消息队列）实现通信，支持单独升级。
2. 支持可配置项：并行任务最大数量、mcp服务地址/超时时间、任务重试次数等。
3. 需兼容常见输入格式（文本、结构化JSON），输出格式可通过用户需求指定（如“请以表格形式输出”）。
